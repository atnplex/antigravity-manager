name: "CodeQL (Optimized)"

on:
  push:
    branches: ["main"]
    paths:
      - "**.rs"
      - "**.ts"
      - "**.js"
      - "**.yml"
      - "**.rb"
  pull_request:
    branches: ["main"]
    paths:
      - "**.rs"
      - "**.ts"
      - "**.js"
      - "**.yml"
      - "**.rb"

permissions:
  contents: read
  security-events: write
  actions: read

jobs:
  # Fast checks for TypeScript/JavaScript (common changes)
  analyze-js:
    name: Analyze (JavaScript/TypeScript)
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: |
      contains(github.event.head_commit.message, '[js]') ||
      github.event_name == 'push' ||
      contains(toJSON(github.event.pull_request.labels.*.name), 'js') ||
      !contains(github.event.head_commit.message, '[skip-js]')
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Check for JS/TS changes
        id: js-changes
        run: |
          if git diff --name-only HEAD~1 | grep -qE '\.(ts|js|tsx|jsx)$'; then
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Initialize CodeQL
        if: steps.js-changes.outputs.changed == 'true'
        uses: github/codeql-action/init@v3
        with:
          languages: javascript-typescript

      - name: Perform CodeQL Analysis
        if: steps.js-changes.outputs.changed == 'true'
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:javascript-typescript"

  # Rust analysis (only when Rust files change)
  analyze-rust:
    name: Analyze (Rust)
    runs-on: ubuntu-latest
    timeout-minutes: 45
    # Run on all relevant events (filtering handled by on.paths)
    # if: removed to allow PRs without labels to trigger checks
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Check for Rust changes
        id: rust-changes
        run: |
          if git diff --name-only HEAD~1 | grep -qE '\.rs$|Cargo\.(toml|lock)$'; then
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Skip Rust analysis (no changes)
        if: steps.rust-changes.outputs.changed == 'false'
        run: echo "No Rust files changed, skipping analysis"

      - name: Install Rust toolchain
        if: steps.rust-changes.outputs.changed == 'true'
        uses: dtolnay/rust-toolchain@stable

      - name: Initialize CodeQL
        if: steps.rust-changes.outputs.changed == 'true'
        uses: github/codeql-action/init@v3
        with:
          languages: rust

      - name: Install system dependencies
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libgtk-3-dev \
            libglib2.0-dev \
            libappindicator3-dev \
            libwebkit2gtk-4.0-dev \
            pkg-config \
            build-essential
      - name: Build Rust (for CodeQL)
        if: steps.rust-changes.outputs.changed == 'true'
        run: cargo build --manifest-path src-tauri/Cargo.toml
        env:
          CARGO_INCREMENTAL: 0

      - name: Perform CodeQL Analysis
        if: steps.rust-changes.outputs.changed == 'true'
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:rust"

  # Actions/Ruby (fast, rarely changes)
  analyze-actions:
    name: Analyze (Actions/Ruby)
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Check for workflow/ruby changes
        id: actions-changes
        run: |
          if git diff --name-only HEAD~1 | grep -qE '\.(yml|yaml|rb)$'; then
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Initialize CodeQL (Actions)
        if: steps.actions-changes.outputs.changed == 'true'
        uses: github/codeql-action/init@v3
        with:
          languages: actions

      - name: Initialize CodeQL (Ruby)
        if: steps.actions-changes.outputs.changed == 'true'
        uses: github/codeql-action/init@v3
        with:
          languages: ruby

      - name: Perform CodeQL Analysis
        if: steps.actions-changes.outputs.changed == 'true'
        uses: github/codeql-action/analyze@v3
